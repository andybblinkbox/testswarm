<div ng-app="dashboard">
	<div ng:controller="devicesController">
		<div><span ng:show="loading">Updating...</span></div>
		<table>
			<tr>
				<th>id</th>
				<th>ip</th>
				<th>browser name</th>
				<th>updated</th>
			</tr>
			<tr ng-repeat="device in devices">
				<td>{{device.ip}}</td>
				<td>{{device.browserName}}</td>
				<td>{{device.updated}}</td>
			</tr>
		</table>
	</div>
	<hr/>
	<div ng:controller="configController">
		<p>Device alive threshold: {{deviceAliveThreshold}}s</p>
		<p>Dashboard refresh interval: {{refreshInterval}}s</p>
	</div>
</div>
<script type="text/javascript" src="/testswarm/js/angular.min.js"></script>
<script type="text/javascript" src="/testswarm/js/angular-resource.min.js"></script>
<script type="text/javascript">

	angular
		.module('dashboard', [ 'ngResource' ])
		.factory('config', [function () {
		
			var config = { 
				deviceAliveThreshold: window.SWARM.conf.client.pingTime + window.SWARM.conf.client.pingTimeMargin,
				refreshInterval: 5
			};
			
			return config;
		}])
		.factory('api', ['$resource', function ($resource) {
			return $resource('api.php', { action: 'dashboardRefresh' }, { 'query': { method: 'POST' } });
		}]);
		
	function configController($scope, config) {
	   $scope.deviceAliveThreshold = config.deviceAliveThreshold;
	   $scope.refreshInterval = config.refreshInterval;
	}
	
	function devicesController($scope, $timeout, api, config) {
		
		$scope.refresh = function () {
			$scope.loading = true;
			
			var result = api.query(function() {
				$scope.loading = false;
				$scope.devices = result.dashboardRefresh.devices;
				$timeout( $scope.refresh, config.refreshInterval * 1000 );
			});
		}
		
		$scope.refresh();
	}

</script>