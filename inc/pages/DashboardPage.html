<div ng-app="dashboard">
	<div ng:controller="devicesController">
		<table class="table table-striped table-hover table-condensed">
			<caption>{{devices.length}} devices found, updating data in {{secondsToUpdateText()}}...</caption>
			<thead>
				<tr>
					<th>IP address</th>
					<th>Browser</th>
					<th>Last seen</th>
				</tr>
			</thead>
			<tbody>
				<!-- row classes success, error, warning, info -->
				<tr ng-repeat="device in devices">
					<td>{{device.ip}}</td>
					<td>{{device.browserName}}</td>
					<td>{{device.lastSeen}}</td>
				</tr>
			</tbody>
		</table>		
	</div>
	<hr/>
	<div ng:controller="configController">
		<button class="btn btn-inverse" ng:click="modalShown=true">Dashboard settings</button>
		
		<div ui-modal ng:model="modalShown">
			<div class="modal-header">
				<h1>Dashboard settings</h1>
			</div>
			<div class="modal-body">
				<p><span>Device alive threshold</span> <strong>{{deviceAliveThreshold}}s</strong></p>
				<p><span>Device too old threshold</span> <strong>{{deviceTooOldThreshold}}s ( {{ deviceTooOldThreshold / (24*60*60) }} days )</strong></p>		
				<p><span>Dashboard refresh interval</span> <strong>{{refreshInterval}}s</strong></p>
			</div>
			<div class="modal-footer">
				<a class="btn btn-info" ng-click="modalShown=false" href="">Close</a>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript" src="/testswarm/js/angular.min.js"></script>
<script type="text/javascript" src="/testswarm/js/angular-resource.min.js"></script>
<script type="text/javascript" src="/testswarm/js/angular-ui.min.js"></script>
<script type="text/javascript" src="/testswarm/js/bootstrap-modal.js"></script>
<script type="text/javascript">
	angular
		.module('dashboard', [ 'ngResource', 'ui' ])
		.factory('config', [function () {
		
			var config = { 
				deviceAliveThreshold: window.SWARM.conf.client.pingTime + window.SWARM.conf.client.pingTimeMargin,
				deviceTooOldThreshold: 60 * 60 * 24 * 15,	// consider devices older then 15 days as not relevant
				refreshInterval: 5
			};
			
			return config;
		}])
		.factory('api', ['$resource', 'config', function ($resource, config) {
			return $resource('api.php', { action: 'dashboardRefresh' }, { 'query': { method: 'POST', isArray: false, params: { deviceTooOldThreshold: config.deviceTooOldThreshold } } });
		}]);
		
	function configController($scope, config) {
	   $scope.deviceAliveThreshold = config.deviceAliveThreshold;
	   $scope.deviceTooOldThreshold = config.deviceTooOldThreshold;
	   $scope.refreshInterval = config.refreshInterval;
	}
	
	function devicesController($scope, $timeout, api, config) {
		$scope.secondsToUpdate = 0;
	
		// Device class
		function Device (device, now) {
			this.id = parseInt(device.id);
			this.ip = device.ip;
			this.browserName = device.browserName;
			this.updated = new Date(device.updated * 1000);
			
			this.lastSeen = getLastSeenText((now - this.updated) / 1000);
			
			function getLastSeenText(seconds) {
				var daysDifference = Math.floor(seconds/60/60/24);
				seconds -= daysDifference*60*60*24;
 
				var hoursDifference = Math.floor(seconds/60/60);
				seconds -= hoursDifference*60*60;
 
				var minutesDifference = Math.floor(seconds/60);
				seconds -= minutesDifference*60;
 				
				var result = [];
				
				if(daysDifference > 0) {
					result.push(daysDifference);
					result.push('days');
				}
				
				if(hoursDifference > 0) {
					result.push(hoursDifference);
					result.push('hours');
				}
				
				if(minutesDifference > 0) {
					result.push(minutesDifference);
					result.push('minutes');
				}
				
				if(result.length == 0) {
					result.push('less then a minute');
				}
				
				result.push('ago');
				
				return result.join(' ');
			}
		}
	
		$scope.refresh = function () {

			if ( $scope.secondsToUpdate <= 0 ) {						
				api.query(function(result) {
					$scope.serverTime = new Date(result.dashboardRefresh.serverTime * 1000); // convert unix timestamp to javascript date
					
					var devices = [];
					
					for(var i=0; i < result.dashboardRefresh.devices.length; i++) {
						var device = new Device(result.dashboardRefresh.devices[i], $scope.serverTime);
						devices.push(device);
					}
					
					// Find a better way of updating the devices on the scope. Need to update rather then overwrite. Try to find a way to intercept class creation in the resource service.
					$scope.devices = devices;
					$scope.secondsToUpdate = config.refreshInterval;			
					$timeout( $scope.refresh, 1000 );
				});				
			} else {
				$scope.secondsToUpdate--;
				$timeout( $scope.refresh, 1000 );
			}
		}
		
		$scope.secondsToUpdateText = function () {
			return $scope.secondsToUpdate <= 0 ? "in progress" : $scope.secondsToUpdate + "s";
		}
		
		$scope.refresh();
	}
</script>